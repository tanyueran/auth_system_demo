<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.github.tanyueran.auth_system.mapper.UserMapper">
    <!--查询用户信息-->
    <resultMap id="userMap" type="UserPojo">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="userCode" property="userCode"/>
        <result column="file_id" property="file_id"/>
        <result column="password" property="password"/>
        <result column="sex" property="sex"/>
        <result column="desc" property="desc"/>
        <collection property="roles" column="id" ofType="com.github.tanyueran.auth_system.pojo.RolePojo" select="getRoleByUserId"/>
    </resultMap>

    <!--查询角色-->
    <resultMap id="roleMap" type="RolePojo">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="code" property="code"/>
        <collection property="auths" column="id" ofType="Auth" select="getAuthByRoleId">
            <result column="id" property="id"/>
            <result column="pid" property="pid"/>
            <result column="name" property="name"/>
            <result column="code" property="code"/>
            <result column="type" property="type"/>
            <result column="remark" property="remark"/>
            <result column="data" property="data"/>
        </collection>
    </resultMap>

    <!--查询用户信息-->
    <select id="getUserInfoByUserCode" resultMap="userMap">
        SELECT
            *
        FROM
            `t_user`
        WHERE
            userCode = #{userCode}
    </select>


    <!--查询角色-->
    <select id="getRoleByUserId" resultMap="roleMap" parameterType="Integer">
      SELECT
            *
        FROM
            `t_role_user` ru
            LEFT JOIN t_role r ON ru.role_id = r.id
        WHERE
            ru.user_id = #{userId}
    </select>

    <!--查询用户的资源权限-->
    <select id="getAuthByRoleId" resultType="Auth" parameterType="Integer">
        SELECT
            *
        FROM
            `t_auth_role` ar
            LEFT JOIN `t_auth` a ON ar.role_id = a.id
        WHERE
            ar.role_id = #{roleId}
    </select>

    <!--新增用户-->
    <insert id="addUser" parameterType="User">
      INSERT INTO `t_user` ( id, username, `password`, userCode, sex, `desc` )
        VALUES
            (null, #{username}, #{password}, #{userCode},#{sex},#{desc})
    </insert>

</mapper>